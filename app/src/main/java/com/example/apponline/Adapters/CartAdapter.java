package com.example.apponline.Adapters;

import android.content.Context;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.TextView;
import androidx.annotation.NonNull;
import androidx.recyclerview.widget.RecyclerView;
import com.bumptech.glide.Glide;
import com.example.apponline.R;
import com.example.apponline.models.OrderItem;
import com.example.apponline.firebase.CartManager;
import java.util.List;

public class CartAdapter extends RecyclerView.Adapter<CartAdapter.CartViewHolder> {

    private final Context context;
    private List<OrderItem> cartList; // üö® B·ªè final ƒë·ªÉ c√≥ th·ªÉ c·∫≠p nh·∫≠t danh s√°ch
    private final CartUpdateListener listener;

    public interface CartUpdateListener {
        void onQuantityChanged();
        void onItemRemoved();
    }

    public CartAdapter(Context context, List<OrderItem> cartList, CartUpdateListener listener) {
        this.context = context;
        this.cartList = cartList;
        this.listener = listener;
    }

    // üö® TH√äM PH∆Ø∆†NG TH·ª®C C·∫¨P NH·∫¨T DANH S√ÅCH (ƒê·ªÅ xu·∫•t s·ª≠a ·ªü CartActivity)
    public void updateItems(List<OrderItem> newCartList) {
        this.cartList = newCartList;
        notifyDataSetChanged();
    }

    @NonNull
    @Override
    public CartViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
        View view = LayoutInflater.from(context).inflate(R.layout.item_cart, parent, false);
        return new CartViewHolder(view);
    }

    @Override
    public void onBindViewHolder(@NonNull CartViewHolder holder, int position) {
        // Lu√¥n s·ª≠ d·ª•ng v·ªã tr√≠ m·ªõi nh·∫•t cho kh·ªëi click
        // final int currentPosition = holder.getBindingAdapterPosition(); // Khai b√°o n√†y kh√¥ng c·∫ßn thi·∫øt
        // if (currentPosition == RecyclerView.NO_POSITION) return;

        OrderItem item = cartList.get(position); // D√πng position v√¨ n√≥ ·ªïn ƒë·ªãnh h∆°n khi binding

        holder.tvName.setText(item.getName());
        holder.tvPrice.setText(String.format("Gi√°: %,.0f VNƒê", item.getPrice()));
        holder.tvQuantity.setText(String.valueOf(item.getQuantity()));

        // --- C·∫≠p nh·∫≠t hi·ªÉn th·ªã SIZE ---
        String size = item.getselectedSize();
        if (size != null && !size.isEmpty()) {
            holder.tvSize.setText("Size: " + size);
            holder.tvSize.setVisibility(View.VISIBLE);
        } else {
            holder.tvSize.setVisibility(View.GONE);
        }

        // --- T·∫¢I H√åNH ·∫¢NH S·ª¨ D·ª§NG GLIDE ---
        String imageUrl = item.getImageUrl();
        if (imageUrl != null && !imageUrl.isEmpty()) {
            Glide.with(context)
                    .load(imageUrl)
                    .placeholder(R.drawable.product_placeholder)
                    .error(R.drawable.product_placeholder)
                    .into(holder.ivProduct);
        } else {
            holder.ivProduct.setImageResource(R.drawable.product_placeholder);
        }

        // --- Logic Gi·∫£m S·ªë l∆∞·ª£ng ---
        holder.btnMinus.setOnClickListener(v -> {
            int clickPosition = holder.getBindingAdapterPosition();
            if (clickPosition == RecyclerView.NO_POSITION) return;

            OrderItem clickedItem = cartList.get(clickPosition);
            int currentQty = clickedItem.getQuantity();

            if (currentQty <= 1) {
                // X√≥a m·ª•c
                CartManager.getInstance().removeItem(clickedItem);
                cartList.remove(clickPosition);

                notifyItemRemoved(clickPosition);
                // üö® B·ªé notifyItemRangeChanged() - ch·ªâ c·∫ßn g·ªçi listener

                listener.onItemRemoved(); // G·ªçi callback ƒë·ªÉ c·∫≠p nh·∫≠t t·ªïng ti·ªÅn
            } else {
                int newQty = currentQty - 1;
                CartManager.getInstance().updateQuantity(clickedItem, newQty);
                notifyItemChanged(clickPosition);
                listener.onQuantityChanged();
            }
        });

        // --- Logic TƒÉng S·ªë l∆∞·ª£ng ---
        holder.btnPlus.setOnClickListener(v -> {
            int clickPosition = holder.getBindingAdapterPosition();
            if (clickPosition == RecyclerView.NO_POSITION) return;

            OrderItem clickedItem = cartList.get(clickPosition);
            int newQty = clickedItem.getQuantity() + 1;

            CartManager.getInstance().updateQuantity(clickedItem, newQty);
            notifyItemChanged(clickPosition);
            listener.onQuantityChanged();
        });

        // --- Logic X√≥a kh·ªèi Gi·ªè ---
        holder.btnRemove.setOnClickListener(v -> {
            int clickPosition = holder.getBindingAdapterPosition();
            if (clickPosition == RecyclerView.NO_POSITION) return;

            OrderItem clickedItem = cartList.get(clickPosition);

            CartManager.getInstance().removeItem(clickedItem);
            cartList.remove(clickPosition);

            notifyItemRemoved(clickPosition);
            // üö® B·ªé notifyItemRangeChanged() - ch·ªâ c·∫ßn g·ªçi listener

            listener.onItemRemoved(); // G·ªçi callback ƒë·ªÉ c·∫≠p nh·∫≠t t·ªïng ti·ªÅn
        });
    }

    @Override
    public int getItemCount() {
        return cartList.size();
    }

    // ... CartViewHolder class gi·ªØ nguy√™n
    public static class CartViewHolder extends RecyclerView.ViewHolder {
        ImageView ivProduct;
        TextView tvName, tvPrice, tvQuantity, tvSize;
        ImageButton btnMinus, btnPlus, btnRemove;

        public CartViewHolder(@NonNull View itemView) {
            super(itemView);

            ivProduct = itemView.findViewById(R.id.iv_cart_product);
            tvName = itemView.findViewById(R.id.tv_cart_name);
            tvPrice = itemView.findViewById(R.id.tv_cart_price);
            tvQuantity = itemView.findViewById(R.id.tv_cart_quantity);
            tvSize = itemView.findViewById(R.id.tv_cart_size);

            btnMinus = itemView.findViewById(R.id.btn_minus);
            btnPlus = itemView.findViewById(R.id.btn_plus);
            btnRemove = itemView.findViewById(R.id.btn_remove);
        }
    }
}